"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[4676],{25:(e,n,s)=>{s.d(n,{A:()=>i});const i=s.p+"assets/images/add_file-1666f3c6b771c0c68eb0d7799005076e.png"},6843:(e,n,s)=>{s.d(n,{A:()=>i});const i=s.p+"assets/images/hidden_view-a9c99e454ddc39600b3b485b0e6a2125.png"},6854:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>c,contentTitle:()=>o,default:()=>h,frontMatter:()=>l,metadata:()=>i,toc:()=>d});const i=JSON.parse('{"id":"access-control/index","title":"Access Control with Cube","description":"Cube provides comprehensive security features that go beyond simple row-level filtering. You can implement row-level security, column-level masking, control cube and view visibility, and build multi-tenant architectures - all applied automatically across every query, regardless of the API used.","source":"@site/docs/access-control/index.md","sourceDirName":"access-control","slug":"/access-control/","permalink":"/cube-workshop/docs/access-control/","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":1,"frontMatter":{"sidebar_position":1},"sidebar":"workshopSidebar","previous":{"title":"Data Modeling with Cube","permalink":"/cube-workshop/docs/data-modeling/"},"next":{"title":"Caching with Cube","permalink":"/cube-workshop/docs/caching/"}}');var r=s(4848),t=s(8453);const l={sidebar_position:1},o="Access Control with Cube",c={},d=[{value:"Why Access Control Matters",id:"why-access-control-matters",level:2},{value:"Types of Access Control in Cube",id:"types-of-access-control-in-cube",level:2},{value:"1. Row-Level Security (RLS)",id:"1-row-level-security-rls",level:3},{value:"2. Column-Level Masking",id:"2-column-level-masking",level:3},{value:"3. Object Visibility",id:"3-object-visibility",level:3},{value:"4. Multi-Tenancy",id:"4-multi-tenancy",level:3},{value:"Security Context",id:"security-context",level:2},{value:"Implementing Row-Level Security with query_rewrite",id:"implementing-row-level-security-with-query_rewrite",level:2},{value:"Step 1: Define User Mappings",id:"step-1-define-user-mappings",level:3},{value:"Step 2: Implement query_rewrite",id:"step-2-implement-query_rewrite",level:3},{value:"Step 3: Test Security in Playground",id:"step-3-test-security-in-playground",level:3},{value:"Column-Level Masking",id:"column-level-masking",level:2},{value:"Step 1: Update the Phone Dimension",id:"step-1-update-the-phone-dimension",level:3},{value:"Step 2: Add Phone to Sales View",id:"step-2-add-phone-to-sales-view",level:3},{value:"Step 3: Create globals.py for Masking Function",id:"step-3-create-globalspy-for-masking-function",level:3},{value:"Step 4 (and 5): Extend the Security Context",id:"step-4-and-5-extend-the-security-context",level:3},{value:"Exercise: Test PII Masking",id:"exercise-test-pii-masking",level:3},{value:"Object Visibility Control",id:"object-visibility-control",level:2},{value:"Step 1: Update Security Context with Roles",id:"step-1-update-security-context-with-roles",level:3},{value:"Step 2: Create the Director Dashboard View",id:"step-2-create-the-director-dashboard-view",level:3},{value:"Step 3: Create the Sales Team View",id:"step-3-create-the-sales-team-view",level:3},{value:"Exercise: Test View Visibility",id:"exercise-test-view-visibility",level:3},{value:"Advanced: Combining View Visibility with Row-Level Security",id:"advanced-combining-view-visibility-with-row-level-security",level:3},{value:"Pre-Aggregations and Security",id:"pre-aggregations-and-security",level:2},{value:"Security Best Practices",id:"security-best-practices",level:2},{value:"Access Control Summary",id:"access-control-summary",level:3},{value:"Key Takeaways",id:"key-takeaways",level:2},{value:"Commit Your Security Configuration",id:"commit-your-security-configuration",level:2}];function a(e){const n={a:"a",admonition:"admonition",br:"br",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,t.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"access-control-with-cube",children:"Access Control with Cube"})}),"\n",(0,r.jsx)(n.p,{children:"Cube provides comprehensive security features that go beyond simple row-level filtering. You can implement row-level security, column-level masking, control cube and view visibility, and build multi-tenant architectures - all applied automatically across every query, regardless of the API used."}),"\n",(0,r.jsx)(n.p,{children:"In this section, we'll cover some basic implementations of Cube's access control features so you can get a feel for how they work and how they could be extended for your own applications."}),"\n",(0,r.jsx)(n.h2,{id:"why-access-control-matters",children:"Why Access Control Matters"}),"\n",(0,r.jsx)(n.p,{children:"In a B2B environment like TPCH, different users need different data access:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Sales reps"})," should only see their assigned customers' orders"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Regional directors"})," need data for their specific regions"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Global admins"})," require full visibility across all data"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"External partners"})," might access only their relevant supply data"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"types-of-access-control-in-cube",children:"Types of Access Control in Cube"}),"\n",(0,r.jsx)(n.h3,{id:"1-row-level-security-rls",children:"1. Row-Level Security (RLS)"}),"\n",(0,r.jsx)(n.p,{children:"Filter which rows users can see based on their context"}),"\n",(0,r.jsx)(n.h3,{id:"2-column-level-masking",children:"2. Column-Level Masking"}),"\n",(0,r.jsx)(n.p,{children:"Hide or mask sensitive fields like PII data"}),"\n",(0,r.jsx)(n.h3,{id:"3-object-visibility",children:"3. Object Visibility"}),"\n",(0,r.jsx)(n.p,{children:"Control which cubes and views users can access"}),"\n",(0,r.jsx)(n.h3,{id:"4-multi-tenancy",children:"4. Multi-Tenancy"}),"\n",(0,r.jsx)(n.p,{children:"Completely isolate data between different organizations"}),"\n",(0,r.jsx)(n.h2,{id:"security-context",children:"Security Context"}),"\n",(0,r.jsx)(n.p,{children:"Cube's security context is set with each request and can be augmented with lookups to your systems of record. The complete context then flows through to all queries:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:'// Example security context passed from your application\n{\n  user_id: "sarah_jones"\n}\n\n// After enhancing with lookups\n{\n  user_id: "sarah_jones",\n  role: "sales_rep",\n  customer_ids: [101, 105, 112, 118, 125],\n  region: null\n}\n'})}),"\n",(0,r.jsx)(n.h2,{id:"implementing-row-level-security-with-query_rewrite",children:"Implementing Row-Level Security with query_rewrite"}),"\n",(0,r.jsxs)(n.p,{children:["Instead of modifying cube definitions directly, we'll use Cube's powerful ",(0,r.jsx)(n.code,{children:"query_rewrite"})," feature to apply security rules dynamically. This keeps our data model clean and security logic centralized."]}),"\n",(0,r.jsxs)(n.admonition,{title:"Development Mode Reminder",type:"tip",children:[(0,r.jsxs)(n.p,{children:["Before making any changes to your data model, ensure you're in ",(0,r.jsx)(n.strong,{children:"Development Mode"}),":"]}),(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["Navigate to the ",(0,r.jsx)(n.strong,{children:"Data Model"})," page"]}),"\n",(0,r.jsxs)(n.li,{children:["Click ",(0,r.jsx)(n.strong,{children:'"Dev Mode"'})," (top of the interface)"]}),"\n",(0,r.jsx)(n.li,{children:"Create a new branch or continue with your existing development branch"}),"\n"]}),(0,r.jsx)(n.p,{children:"This ensures your security changes won't affect production until you're ready to deploy them."})]}),"\n",(0,r.jsx)(n.h3,{id:"step-1-define-user-mappings",children:"Step 1: Define User Mappings"}),"\n",(0,r.jsxs)(n.p,{children:["First, let's create our hardcoded user mappings in ",(0,r.jsx)(n.code,{children:"cube.py"}),".  In practice, these would come from your authentication system, directory, or entitlements table, but for simplicity in this workshop, we'll define them directly in code.  We'll also add our ",(0,r.jsx)(n.code,{children:"@example.com"})," account as a global admin so we can use D3 with it later."]}),"\n",(0,r.jsx)(n.admonition,{type:"warning",children:(0,r.jsxs)(n.p,{children:["Make sure to update your user email in the first entry of the ",(0,r.jsx)(n.code,{children:"USER_SECURITY_MAPPINGS"})," dictionary below with your workshop email address.  This will ensure you have full access to the data when logged in to D3 in the final workshop module."]})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",metastring:'title="cube.py" {3-43}',children:'from cube import config \n\nUSER_SECURITY_MAPPINGS = {\n    # YOUR USER - UPDATE WITH YOUR WORKSHOP EMAIL\n    "wdc-2025-999@example.com": {\n        "role": "global_admin",\n        "filter_type": "none"\n    },\n    \n    # Global admin - sees everything\n    "admin@tpch.com": {\n        "role": "global_admin",\n        "filter_type": "none"\n    },\n\n    # Regional director - North America (Region 1)\n    "director_na@tpch.com": {\n        "role": "regional_director", \n        "filter_type": "region",\n        "region_key": 1  # AMERICA\n    },\n    \n    # Regional director - Europe (Region 3)\n    "director_eu@tpch.com": {\n        "role": "regional_director",\n        "filter_type": "region", \n        "region_key": 3  # EUROPE\n    },\n    \n    # Sales rep - specific customers\n    "sarah_jones@tpch.com": {\n        "role": "sales_rep",\n        "filter_type": "customers",\n        "customer_keys": [1, 7, 13, 19, 25]  # 5 customers\n    },\n    \n    # Sales rep - different customers\n    "mike_chen@tpch.com": {\n        "role": "sales_rep",\n        "filter_type": "customers",\n        "customer_keys": [2, 8, 14, 20, 26, 27, 28]  # 7 customers\n    }\n}\n'})}),"\n",(0,r.jsx)(n.h3,{id:"step-2-implement-query_rewrite",children:"Step 2: Implement query_rewrite"}),"\n",(0,r.jsxs)(n.p,{children:["Add the security filtering logic to the end of ",(0,r.jsx)(n.code,{children:"cube.py"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",metastring:'title="cube.py" ',children:"@config('query_rewrite')\ndef query_rewrite(query: dict, ctx: dict) -> dict:\n    # Get user from security context\n    user_id = ctx.get('securityContext', {}).get('user_id')\n    \n    # Look up user's security settings\n    user_security = USER_SECURITY_MAPPINGS.get(user_id, {})\n    \n    # Default to no access if user not found\n    if not user_security:\n        # Add impossible filter to return no data\n        query['filters'].append({\n            'member': 'sales.c_custkey',\n            'operator': 'equals',\n            'values': ['-1']  # Non-existent customer\n        })\n        return query\n    \n    # Apply filters based on user type\n    filter_type = user_security.get('filter_type')\n    \n    if filter_type == 'none':\n        # Global admin - no filters needed\n        pass\n        \n    elif filter_type == 'region':\n        # Regional director - filter by region\n        query['filters'].append({\n            'member': 'customer_regions.region_key',\n            'operator': 'equals',\n            'values': [str(user_security['region_key'])]\n        })\n        \n    elif filter_type == 'customers':\n        # Sales rep - filter by customer list\n        query['filters'].append({\n            'member': 'customers.customer_key',\n            'operator': 'in',\n            'values': [str(ck) for ck in user_security['customer_keys']]\n        })\n    \n    return query\n"})}),"\n",(0,r.jsxs)(n.p,{children:["We also need to include the fields in our view that we'll be filtering on. Update your ",(0,r.jsx)(n.code,{children:"sales"})," cube definition to include the necessary dimensions:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",metastring:'title="/model/views/sales.yml" {10,26}',children:"...\n\n      # Customer information via orders\n      - join_path: line_items.orders.customers\n        prefix: true\n        includes:\n          - name\n          - segment\n          - account_balance\n          - customer_key\n        excludes:\n          - phone \n          - address\n          - comment\n          \n      # Geographic data\n      - join_path: line_items.orders.customers.customer_nations\n        includes:\n          - name: name\n            alias: nation\n            \n      - join_path: line_items.orders.customers.customer_nations.customer_regions\n        includes:\n          - name: name\n            alias: region\n          - region_key\n"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Save your changes"}),"."]}),"\n",(0,r.jsx)(n.h3,{id:"step-3-test-security-in-playground",children:"Step 3: Test Security in Playground"}),"\n",(0,r.jsx)(n.p,{children:"In the Cube Playground, you can test different security contexts:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Click the Security Context button -> Edit"})," (top-right corner)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Test Global Admin"}),":","\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{\n  "user_id": "admin@tpch.com"\n}\n'})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Test Regional Director (North America)"}),":","\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{\n  "user_id": "director_na@tpch.com"\n}\n'})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Test Sales Rep"}),":","\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{\n  "user_id": "sarah_jones@tpch.com"\n}\n'})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"column-level-masking",children:"Column-Level Masking"}),"\n",(0,r.jsx)(n.p,{children:"Beyond row-level security, you can mask sensitive columns based on user roles using masking functions in your cube definitions. This is useful for hiding personally identifiable information (PII) like phone numbers or social security numbers for most users, while allowing a specific class of user to see the full data."}),"\n",(0,r.jsx)(n.p,{children:"In this example, we'll mask phone numbers for sales reps and regional directors, but allow global admins to see them.  We'll make 5 changes to our data model to make this work:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["Update the phone dimension in the ",(0,r.jsx)(n.code,{children:"customers"})," cube to use a masking function"]}),"\n",(0,r.jsxs)(n.li,{children:["Add the phone dimension to the ",(0,r.jsx)(n.code,{children:"sales"})," view so it can be queried"]}),"\n",(0,r.jsxs)(n.li,{children:["Add a ",(0,r.jsx)(n.code,{children:"globals.py"})," file to define the masking function"]}),"\n",(0,r.jsx)(n.li,{children:"Extend the security context to lookup the user's PII access"}),"\n",(0,r.jsxs)(n.li,{children:["Add the ",(0,r.jsx)(n.code,{children:"context_to_app_id"})," function to cache our model both with PII access and without PII access"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"step-1-update-the-phone-dimension",children:"Step 1: Update the Phone Dimension"}),"\n",(0,r.jsxs)(n.p,{children:["Update the existing phone dimension in your ",(0,r.jsx)(n.code,{children:"customers"})," cube to include PII masking:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",metastring:'title="/model/cubes/customers.yml" {4}',children:"...\n\n      - name: phone\n        sql: {{ masked('c_phone', COMPILE_CONTEXT.securityContext) }}\n        type: string\n        title: Phone Number\n\n...\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Key Points:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Use ",(0,r.jsx)(n.code,{children:"COMPILE_CONTEXT.securityContext"})," to access the security context and send it to the ",(0,r.jsx)(n.code,{children:"masked()"})," function"]}),"\n",(0,r.jsxs)(n.li,{children:["The ",(0,r.jsx)(n.code,{children:"masked()"})," function will return the phone number as ",(0,r.jsx)(n.code,{children:"--- masked ---"})," for users without PII access"]}),"\n",(0,r.jsxs)(n.li,{children:["The ",(0,r.jsx)(n.code,{children:"masked()"})," function will return the actual phone number ",(0,r.jsx)(n.code,{children:"c_phone"})," for users with PII access"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"step-2-add-phone-to-sales-view",children:"Step 2: Add Phone to Sales View"}),"\n",(0,r.jsxs)(n.p,{children:["We also need to include the phone field in our sales view. Update your ",(0,r.jsx)(n.code,{children:"sales"})," view definition to move the phone dimension from ",(0,r.jsx)(n.code,{children:"excludes"})," to ",(0,r.jsx)(n.code,{children:"includes"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",metastring:'title="/model/views/sales.yml" {11}',children:"...\n\n      # Customer information via orders\n      - join_path: line_items.orders.customers\n        prefix: true\n        includes:\n          - name\n          - segment\n          - account_balance\n          - customer_key\n          - phone \n        excludes:\n          - address\n          - comment\n\n...\n"})}),"\n",(0,r.jsx)(n.h3,{id:"step-3-create-globalspy-for-masking-function",children:"Step 3: Create globals.py for Masking Function"}),"\n",(0,r.jsxs)(n.p,{children:["Create a new file ",(0,r.jsx)(n.code,{children:"globals.py"})," in your Cube project directory in the ",(0,r.jsx)(n.code,{children:"model"})," folder by hovering over the ",(0,r.jsx)(n.code,{children:"model"})," folder and clicking the ",(0,r.jsx)(n.code,{children:"..."})," icon, then ",(0,r.jsx)(n.strong,{children:"Add File"}),"*."]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{alt:"How to add a file in Cube IDE",src:s(25).A+"",width:"1204",height:"820"})}),"\n",(0,r.jsxs)(n.p,{children:["Add the following code to the new ",(0,r.jsx)(n.code,{children:"globals.py"})," file to define the masking function:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",metastring:'title="/model/globals.py" ',children:"from cube import config, TemplateContext\n \ntemplate = TemplateContext()\n \n@template.function('masked')\ndef masked(sql, security_context):\n  \n  # Check if security_context is None or empty\n  if not security_context:\n    return \"'--- masked ---'\"\n  \n  # Safely get the show_pii value\n  show_pii = security_context.get('show_pii', 'false')\n  \n  # Use explicit string comparison and handle case sensitivity\n  if show_pii.lower() == 'true':\n    return sql\n  else:\n    return \"'--- masked ---'\"\n"})}),"\n",(0,r.jsxs)(n.p,{children:["This function checks the ",(0,r.jsx)(n.code,{children:"show_pii"})," flag in the security context and returns either the actual SQL column or a masked value."]}),"\n",(0,r.jsx)(n.h3,{id:"step-4-and-5-extend-the-security-context",children:"Step 4 (and 5): Extend the Security Context"}),"\n",(0,r.jsxs)(n.p,{children:["In ",(0,r.jsx)(n.em,{children:(0,r.jsx)(n.strong,{children:"cube.py"})}),", we need to extend our security context to include the ",(0,r.jsx)(n.code,{children:"show_pii"})," flag based on the user's role.  We also want to cache multiple versions of our data model - one with PII and one without - so users with different permissions don't see the other's cache.  Add the following code to the end of your ",(0,r.jsx)(n.code,{children:"cube.py"})," file:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",metastring:'title="/cube.py" {3-32}',children:"...\n\n@config('extend_context')\ndef extend_context(req: dict) -> dict:\n    # Check if securityContext exists, skip extending context if not\n    if 'securityContext' not in req:\n        return req\n    \n    # Get user from security context - handle both React app and D3 formats\n    security_context = req.get('securityContext', {})\n    # If D3 format (has cubeCloud key), extract username from cubeCloud.username\n    if 'cubeCloud' in security_context:\n        user_id = security_context.get('cubeCloud', {}).get('username')\n        # Update the user_id in the security context\n        req['securityContext']['user_id'] = user_id\n    else:\n        # For React app format, use existing user_id\n        user_id = security_context.get('user_id', 'anonymous')\n    \n    # Look up user security settings\n    user_security = USER_SECURITY_MAPPINGS.get(user_id, {})\n    \n    # Set the show_pii flag in security context for template function\n    req['securityContext']['show_pii'] = user_security.get('show_pii', 'false')\n\n    return req\n\n@config('context_to_app_id')\ndef context_to_app_id(ctx: dict) -> str:\n    # Only use the show_pii value for caching\n    show_pii = ctx.get('securityContext', {}).get('show_pii', 'false')\n    return f\"CUBE_APP_PII_{show_pii}\"\n\n"})}),"\n",(0,r.jsx)(n.h3,{id:"exercise-test-pii-masking",children:"Exercise: Test PII Masking"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Navigate to Playground"})," and open the ",(0,r.jsx)(n.code,{children:"sales"})," view"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Add measures"}),": ",(0,r.jsx)(n.code,{children:"total_sales_amount"})," and ",(0,r.jsx)(n.code,{children:"orders_count"})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Add dimensions"}),": ",(0,r.jsx)(n.code,{children:"region"}),", ",(0,r.jsx)(n.code,{children:"customers_name"}),", and ",(0,r.jsx)(n.code,{children:"customers_phone"})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Test with different security contexts"}),":","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Admin (should see real phone numbers)"}),":","\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{ "user_id": "admin@tpch.com" }\n'})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Sales Rep (should see masked phone numbers)"}),":","\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{ "user_id": "sarah_jones@tpch.com" }\n'})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Observe the results"}),":","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Admin"}),": Sees actual phone numbers from the data"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Sales Rep"}),': Sees "--- masked ---" for all phone numbers, and still only her customers']}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{alt:"Sarah sees masked phone numbers",src:s(7558).A+"",width:"3020",height:"1194"})}),"\n",(0,r.jsx)(n.h2,{id:"object-visibility-control",children:"Object Visibility Control"}),"\n",(0,r.jsx)(n.p,{children:"Beyond row-level security and column masking, you can control which entire views (and cubes) are visible to different users. This is powerful for creating role-specific dashboards and analytics experiences."}),"\n",(0,r.jsx)(n.p,{children:"In this section, we'll create two new views:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Director Dashboard"})," - A high-level view with sensitive metrics only for directors and admins"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Sales Team View"})," - A simplified view for sales reps with just their relevant metrics"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"step-1-update-security-context-with-roles",children:"Step 1: Update Security Context with Roles"}),"\n",(0,r.jsxs)(n.p,{children:["First, we need to ensure user roles are available in the security context. Update your ",(0,r.jsx)(n.code,{children:"extend_context"})," function in ",(0,r.jsx)(n.code,{children:"cube.py"})," to include the user's role.  We'll also make our function more robust to handle both the React app and D3 formats of the security context:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",metastring:'title="/cube.py" {9-19,26}',children:"...\n\n@config('extend_context')\ndef extend_context(req: dict) -> dict:\n    # Check if securityContext exists, skip extending context if not\n    if 'securityContext' not in req:\n        return req\n    \n    # Get user from security context - handle both React app and D3 formats\n    security_context = req.get('securityContext', {})\n\n    # If D3 format (has cubeCloud key), extract username from cubeCloud.username\n    if 'cubeCloud' in security_context:\n        user_id = security_context.get('cubeCloud', {}).get('username')\n        # Update the user_id in the security context\n        req['securityContext']['user_id'] = user_id\n    else:\n        # For React app format, use existing user_id\n        user_id = security_context.get('user_id', 'anonymous')\n    \n    # Look up user security settings\n    user_security = USER_SECURITY_MAPPINGS.get(user_id, {})\n    \n    # Set both show_pii and role in security context\n    req['securityContext']['show_pii'] = user_security.get('show_pii', 'false')\n    req['securityContext']['role'] = user_security.get('role', 'viewer')  # Add role\n\n    return req\n\n...\n"})}),"\n",(0,r.jsx)(n.p,{children:"Since we're now using dynamic view visibility based on roles, we should update our cache keys to include the role. This ensures that users with different roles get separate cached versions of the data model (which may have different visible views):"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",metastring:'title="/cube.py" {5-12}',children:"...\n\n@config('context_to_app_id')\ndef context_to_app_id(ctx: dict) -> str:\n    security_context = ctx.get('securityContext', {})\n    show_pii = security_context.get('show_pii', 'false')\n    role = security_context.get('role', 'viewer')\n    \n    # Create a cache key that includes both role and PII access\n    # This ensures users with different roles get separate cached data models\n    return f\"CUBE_APP_{role}_{show_pii}\"\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Why include role in cache keys?"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Different roles see different views (dynamic visibility)"}),"\n",(0,r.jsx)(n.li,{children:"Cube needs separate compiled data models for each role"}),"\n",(0,r.jsx)(n.li,{children:"Prevents one role from seeing cached views meant for another role"}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"step-2-create-the-director-dashboard-view",children:"Step 2: Create the Director Dashboard View"}),"\n",(0,r.jsxs)(n.p,{children:["Create a new file ",(0,r.jsx)(n.code,{children:"director_dashboard.yml"})," in your ",(0,r.jsx)(n.code,{children:"model/views"})," folder:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",metastring:'title="/model/views/director_dashboard.yml" ',children:"views:\n  - name: director_dashboard\n    description: \"High-level metrics for directors and admins only\"\n    # Dynamic visibility - only directors and admins can see this view\n    public: \"{{ COMPILE_CONTEXT.securityContext.role in ['global_admin', 'regional_director'] }}\"\n    \n    cubes:\n      # Revenue metrics from line items\n      - join_path: line_items\n        includes:\n          - total_sales_amount\n          - total_discount\n          \n      # Order-level metrics\n      - join_path: line_items.orders\n        prefix: true\n        includes:\n          - count\n          - total_revenue\n          - average_order_value\n          \n      # Customer insights\n      - join_path: line_items.orders.customers\n        prefix: true\n        includes:\n          - count\n          - average_customer_value\n          - segment\n          \n      # Regional breakdown\n      - join_path: line_items.orders.customers.customer_nations.customer_regions\n        includes:\n          - name: name\n            alias: region\n          - region_key\n            \n      # Time dimensions for trending\n      - join_path: line_items.orders\n        includes:\n          - order_date\n"})}),"\n",(0,r.jsx)(n.h3,{id:"step-3-create-the-sales-team-view",children:"Step 3: Create the Sales Team View"}),"\n",(0,r.jsxs)(n.p,{children:["Create another file ",(0,r.jsx)(n.code,{children:"sales_team.yml"})," in your ",(0,r.jsx)(n.code,{children:"model/views"})," folder:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",metastring:'title="/model/views/sales_team.yml"',children:"views:\n  - name: sales_team\n    description: \"Simplified view for sales representatives\"\n    # Visible to sales reps, directors, and admins\n    public: \"{{ COMPILE_CONTEXT.securityContext.role in ['sales_rep', 'global_admin'] }}\"\n    \n    cubes:\n      # Basic sales metrics\n      - join_path: line_items\n        includes:\n          - quantity\n          - extended_price\n          \n      # Order information\n      - join_path: line_items.orders\n        prefix: true\n        includes:\n          - count\n          - order_date\n          - status\n          - priority\n          \n      # Customer details (with masked PII)\n      - join_path: line_items.orders.customers\n        prefix: true\n        includes:\n          - name\n          - segment\n          - phone  # Will be masked based on PII access\n          \n      # Product information\n      - join_path: line_items.parts\n        prefix: true\n        includes:\n          - name\n          - brand\n          - type\n"})}),"\n",(0,r.jsx)(n.h3,{id:"exercise-test-view-visibility",children:"Exercise: Test View Visibility"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Navigate to Playground"})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Test each user type and observe available views"}),":"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Admin User"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{ "user_id": "admin@tpch.com" }\n'})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Should see: ",(0,r.jsx)(n.code,{children:"sales"}),", ",(0,r.jsx)(n.code,{children:"director_dashboard"}),", ",(0,r.jsx)(n.code,{children:"sales_team"})]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Regional Director"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{ "user_id": "director_na@tpch.com" }\n'})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Should see: ",(0,r.jsx)(n.code,{children:"sales"}),", ",(0,r.jsx)(n.code,{children:"director_dashboard"})]}),"\n",(0,r.jsx)(n.li,{children:"Data filtered to AMERICA region only"}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Sales Rep"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{ "user_id": "sarah_jones@tpch.com" }\n'})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Should see: ",(0,r.jsx)(n.code,{children:"sales"}),", ",(0,r.jsx)(n.code,{children:"sales_team"})]}),"\n",(0,r.jsxs)(n.li,{children:["Should NOT see: ",(0,r.jsx)(n.code,{children:"director_dashboard"})]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Verify data access"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Director sees only their region with masked phone numbers"}),"\n",(0,r.jsx)(n.li,{children:"Sarah sees only her customers with masked phone numbers"}),"\n",(0,r.jsx)(n.li,{children:"Admin sees everything including real phone numbers"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.img,{alt:"Hidden view verification for Director NA",src:s(6843).A+"",width:"3018",height:"716"}),"\nThe padlock icon means this view (or cube or field) is not visible to the current user based on their security context through the APIs."]}),"\n",(0,r.jsx)(n.h3,{id:"advanced-combining-view-visibility-with-row-level-security",children:"Advanced: Combining View Visibility with Row-Level Security"}),"\n",(0,r.jsx)(n.p,{children:"The beauty of Cube's security model is that all security layers work together:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"View Visibility"})," - Controls which views appear in the schema"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Row-Level Security"})," - Filters data within visible views"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Column Masking"})," - Hides sensitive data in visible columns"]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["For example, when Sarah accesses the ",(0,r.jsx)(n.code,{children:"sales_team"})," view:"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"She can see the view (visibility control)"}),"\n",(0,r.jsx)(n.li,{children:"She only sees her 5 customers' data (row-level security)"}),"\n",(0,r.jsx)(n.li,{children:'Phone numbers appear as "--- masked ---" (column masking)'}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"pre-aggregations-and-security",children:"Pre-Aggregations and Security"}),"\n",(0,r.jsx)(n.p,{children:"A critical aspect of Cube's security model is that access control is applied consistently to both:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Live queries"})," to your underlying database"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Cached queries"})," served from pre-aggregations"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"When you define pre-aggregations such as:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"pre_aggregations:\n  - name: revenue_daily\n    measures: [total_sales_amount]\n    dimensions: [region, customers_name]\n    time_dimension: [order_date]\n    granularity: day\n    refresh_key:\n      every: 1 hour\n"})}),"\n",(0,r.jsx)(n.p,{children:"Cube can automatically:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Apply the same filters"})," from query_rewrite (like row-level security) to the pre-aggregated data - one cache to serve all users"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Maintain separate caches"})," for different compiled data models (like with and without PII access, and by role) using the ",(0,r.jsx)(n.code,{children:"context_to_app_id"})," function"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"This means:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Regional directors only see pre-aggregated data for their region"}),"\n",(0,r.jsx)(n.li,{children:"Sales reps only see cached data for their customers"}),"\n",(0,r.jsx)(n.li,{children:"No risk of data leakage through shared caches"}),"\n",(0,r.jsx)(n.li,{children:"Multiple data sources or a mix of pre-aggregate and live queries still respect security rules"}),"\n",(0,r.jsx)(n.li,{children:"High performance with security intact"}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"security-best-practices",children:"Security Best Practices"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Default to restrictive"})," - Unknown users get no data access"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Centralize security logic"})," - Use query_rewrite to keep it in one place"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Test all user types"})," - Verify each role in the Playground"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Document access rules"})," - Keep USER_SECURITY_MAPPINGS well-documented"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Use meaningful test data"})," - Our hardcoded users represent real scenarios"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Layer your security"})," - Combine RLS, column masking, and visibility controls"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"access-control-summary",children:"Access Control Summary"}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"User"}),(0,r.jsx)(n.th,{children:"Role"}),(0,r.jsx)(n.th,{children:"Views Available"}),(0,r.jsx)(n.th,{children:"Data Access"}),(0,r.jsx)(n.th,{children:"PII Access"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.a,{href:"mailto:YOUR_USER@example.com",children:"YOUR_USER@example.com"})}),(0,r.jsx)(n.td,{children:"Global Admin"}),(0,r.jsx)(n.td,{children:"All views"}),(0,r.jsx)(n.td,{children:"All ~60K line items, all regions"}),(0,r.jsx)(n.td,{children:"Yes"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.a,{href:"mailto:admin@tpch.com",children:"admin@tpch.com"})}),(0,r.jsx)(n.td,{children:"Global Admin"}),(0,r.jsx)(n.td,{children:"All views"}),(0,r.jsx)(n.td,{children:"All ~60K line items, all regions"}),(0,r.jsx)(n.td,{children:"Yes"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.a,{href:"mailto:director_na@tpch.com",children:"director_na@tpch.com"})}),(0,r.jsx)(n.td,{children:"Regional Director"}),(0,r.jsx)(n.td,{children:"sales, director_dashboard"}),(0,r.jsx)(n.td,{children:"Only AMERICA region (~12K line items)"}),(0,r.jsx)(n.td,{children:"No"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.a,{href:"mailto:director_eu@tpch.com",children:"director_eu@tpch.com"})}),(0,r.jsx)(n.td,{children:"Regional Director"}),(0,r.jsx)(n.td,{children:"sales, director_dashboard"}),(0,r.jsx)(n.td,{children:"Only EUROPE region (~12K line items)"}),(0,r.jsx)(n.td,{children:"No"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.a,{href:"mailto:sarah_jones@tpch.com",children:"sarah_jones@tpch.com"})}),(0,r.jsx)(n.td,{children:"Sales Rep"}),(0,r.jsx)(n.td,{children:"sales, sales_team"}),(0,r.jsx)(n.td,{children:"Only her 5 customers' orders"}),(0,r.jsx)(n.td,{children:"No"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.a,{href:"mailto:mike_chen@tpch.com",children:"mike_chen@tpch.com"})}),(0,r.jsx)(n.td,{children:"Sales Rep"}),(0,r.jsx)(n.td,{children:"sales, sales_team"}),(0,r.jsx)(n.td,{children:"Only his 5 customers' orders"}),(0,r.jsx)(n.td,{children:"No"})]})]})]}),"\n",(0,r.jsx)(n.h2,{id:"key-takeaways",children:"Key Takeaways"}),"\n",(0,r.jsxs)(n.p,{children:["\u2705 ",(0,r.jsx)(n.strong,{children:"Comprehensive security"})," - Row-level, column-level, and object visibility in one platform",(0,r.jsx)(n.br,{}),"\n","\u2705 ",(0,r.jsx)(n.strong,{children:"Clean data model"})," - Security logic separated from business logic via query_rewrite",(0,r.jsx)(n.br,{}),"\n","\u2705 ",(0,r.jsx)(n.strong,{children:"Consistent enforcement"})," - Same rules for live queries and cached pre-aggregations",(0,r.jsx)(n.br,{}),"\n","\u2705 ",(0,r.jsx)(n.strong,{children:"API agnostic"})," - REST, GraphQL, SQL, MDX, DAX all respect the same security rules"]}),"\n",(0,r.jsx)(n.h2,{id:"commit-your-security-configuration",children:"Commit Your Security Configuration"}),"\n",(0,r.jsx)(n.p,{children:"Now that you've implemented comprehensive access control, let's save your work:"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Step 1: Review Your Changes"})}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Ensure you're in Development Mode"}),' - Look for the "Dev Mode" indicator']}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Test your security setup"})," one final time:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Verify admin user sees all data with real phone numbers"}),"\n",(0,r.jsx)(n.li,{children:"Confirm regional directors see only their region with masked PII"}),"\n",(0,r.jsx)(n.li,{children:"Check that sales reps see only their customers with masked PII"}),"\n",(0,r.jsx)(n.li,{children:"Verify view visibility works correctly for each user type"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Step 2: Commit Your Changes"})}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.strong,{children:"Navigate to the Data Model page"})}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Review all your changes"})," - You should see modified files: ",(0,r.jsx)(n.code,{children:"cube.py"}),", ",(0,r.jsx)(n.code,{children:"globals.py"}),", ",(0,r.jsx)(n.code,{children:"sales.yml"}),", ",(0,r.jsx)(n.code,{children:"director_dashboard.yml"}),", ",(0,r.jsx)(n.code,{children:"sales_team.yml"})]}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.strong,{children:'Click "Commit & Sync"'})}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Add a descriptive commit message"}),":","\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"Implement comprehensive access control\n\n- Add row-level security with query_rewrite for users and regions\n- Implement column masking for PII data (phone numbers)\n- Create role-based view visibility (director_dashboard, sales_team)\n- Configure security context extension and cache isolation\n"})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:'Click "Commit & Sync"'})," to save your security configuration"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"Your access control implementation is now committed and ready for the next module!"}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Next"}),": ",(0,r.jsx)(n.a,{href:"/docs/caching",children:"Caching \u2192"})," - Learn how pre-aggregations accelerate queries while maintaining security."]})]})}function h(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(a,{...e})}):a(e)}},7558:(e,n,s)=>{s.d(n,{A:()=>i});const i=s.p+"assets/images/sarah-playground-384cce716d10dc2b76257fb609e2d590.png"}}]);